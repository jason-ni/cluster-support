<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>matlab - 中国人民大学高性能计算集群</title>
  <!-- <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'> -->

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.github.min.css" type="text/css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "matlab";
    var mkdocs_page_input_path = "manual/matlab.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="../../js/highlight.min.js"></script>
  <script src="../../js/highlight-lang/r.min.js"></script>
  <script src="../../js/highlight-lang/julia.min.js"></script>
  <script src="../../js/highlight-lang/matlab.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> 中国人民大学高性能计算集群</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">首页</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">使用指南</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../getting-started/">快速开始</a>
                </li>
                <li class="">
                    
    <a class="" href="../../intro/">入门知识</a>
                </li>
                <li class="">
                    
    <a class="" href="../../cluster-login/">登录方法</a>
                </li>
                <li class="">
                    
    <a class="" href="../../file/">文件管理</a>
                </li>
                <li class="">
                    
    <a class="" href="../../job-scheduler/">提交作业</a>
                </li>
                <li class="">
                    
    <a class="" href="../../software/">软件使用</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">软件使用</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../python/">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../r/">R</a>
                </li>
                <li class="">
                    
    <a class="" href="../julia/">Julia</a>
                </li>
                <li class="">
                    
    <a class="" href="../jupyter/">Jupyter</a>
                </li>
                <li class="">
                    
    <a class="" href="../ml/">机器学习</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">matlab</a>
    <ul class="subnav">
            
    <!-- <li class="toctree-l3"><a href="#matlab">matlab</a></li> -->
    
        <ul>
        
            <li><a class="toctree-l4" href="#_1">加载软件</a></li>
        
            <li><a class="toctree-l4" href="#matlab_1">提交matlab作业</a></li>
        
            <li><a class="toctree-l4" href="#_2">并行加速</a></li>
        
            <li><a class="toctree-l4" href="#_3">运行多个并行任务</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../singularity/">Singularity</a>
                </li>
                <li class="">
                    
    <a class="" href="../tensorflow/">TensorFlow</a>
                </li>
                <li class="">
                    
    <a class="" href="../chem/">分子模拟软件</a>
                </li>
                <li class="">
                    
    <a class="" href="../math-lib/">数学库</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../reference/">参考资料</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../tutorials/">培训资料</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">中国人民大学高性能计算集群</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">人大集群</a> &raquo;</li>
    
      
        
          <li>软件使用 &raquo;</li>
        
      
    
    <li>matlab</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="matlab">matlab</h1>
<p>MATLAB（矩阵实验室）是MATrix LABoratory的缩写，是一款由美国 MathWorks 公司出品的商业数学软件。MATLAB是一种用于算法开发、数据可视化、数据分析以及数值计算的高级技术计算语言和交互式环境。MATLAB主要用于数值运算，但利用为数众多的附加工具箱（Toolbox）它也适合不同领域的应用，例如控制系统设计与分析、图像处理、信号处理与通讯、金融建模和分析等。</p>
<p>在集群上，一般不推荐使用Matlab的界面，而要用命令行提交批处理任务。</p>
<div class="admonition warning">
<p class="admonition-title">不要直接在登录节点运行matlab！<p>请不要直接在登录节点（IP为183.174.229.251，名为rmdx-cluster的节点）上运行 matlab 任务，而应该使用调度系统来提交任务，否则会影响其他用户使用集群。有关调度系统的介绍和使用，请参考我们提供的<a href="../../job-scheduler/">文档</a>。</p>
</p>
</div>
<h2 id="_1">加载软件</h2>
<pre><code class="bash">module load matlab/2016b
</code></pre>

<h2 id="matlab_1">提交matlab作业</h2>
<p>准备好你的matlab代码，例如 <code>matlab_simple.m</code> 文件：</p>
<pre><code class="matlab">% Creates a 10x10 Magic square
M = magic(10);
M
exit
</code></pre>

<p>准备一个作业提交脚本 <code>submit_matlab.pbs</code> ，其中 <code>-nodisplay</code> 表示不使用图形化界面， <code>-nosplash</code> 表示启动matlab时不显示闪屏版权信息：</p>
<pre><code class="bash">#!/bin/bash

#PBS -N matlab_example
### use one node for this job
#PBS -l nodes=1:ppn=1
#PBS -q default

cd $PBS_O_WORKDIR
module load matlab/2016b
matlab -nodisplay -nosplash &lt; matlab_simple.m
</code></pre>

<p>提交这个任务：</p>
<pre><code class="bash">qsub submit_matlab.pbs
</code></pre>

<h2 id="_2">并行加速</h2>
<p>为了利用集群机器的多个CPU核心，对于计算密集型的任务，可以考虑使用matlab提供的并行工具箱，一些使用方法请阅读官方文档：<a href="https://ww2.mathworks.cn/products/parallel-computing.html">Parallel Computing Toolbox</a>。</p>
<p>一般地，我们可以使用 <code>parfor</code> 来替换原来的 <code>for</code> 来做循环。大致步骤为：</p>
<ol>
<li>创建一个 matlab pool</li>
<li>初始 pool 参数，包括并行处理器数，临时文件地址等</li>
<li>将代码中所有 <code>for</code> 替换为 <code>parfor</code> </li>
</ol>
<p>注意代码中的 <code>parpool()</code> 函数第二个参数要输入并行所使用的CPU核心数。</p>
<p>一个使用 <code>parfor</code> 的简单例子：</p>
<pre><code class="matlab">% start the matlabpool with 24 workers
pc = parcluster('local')

parpool(pc, 24)

% run a parfor loop, distributing the iterations to 24 workers
parfor i = 1:100
        ones(10,10)
end
</code></pre>

<p>一个使用例子 <code>matlab_parfor.m</code> ：</p>
<pre><code class="matlab">%{
   This script samples a parameter of a stiff ODE and solves it both in
   serial and parallel (via parfor), comparing both the run times and the
   max absolute values of the computed solutions. The code -- especially the
   serial part -- will take several minutes to run.
%}

% open the local cluster profile
p = parcluster('local');

% open the parallel pool, recording the time it takes
time_pool = tic;
% set the number of parallel CPU cores 
parpool(p, 24);
time_pool = toc(time_pool);
fprintf('Opening the parallel pool took %g seconds.\n', time_pool)

% create vector of random coefficients on the interval [975,1050]
nsamples = 100; % number of samples
coef = 975 + 50*rand(nsamples,1); % randomly generated coefficients

% compute solutions within serial loop
time_ser = tic;
y_ser = cell(nsamples,1); % cell to save the serial solutions
for i = 1:nsamples
  if mod(i,10)==0
    fprintf('Serial for loop, i = %d\n', i);
  end
  [~,y_ser{i}] = ode15s(@(t,y) stiffODEfun(t,y,coef(i)) ,[0 10000],[2 0]);
end
time_ser = toc(time_ser);

% compute solutions within parfor
time_parfor = tic;
y_par = cell(nsamples,1); % cell to save the parallel solutions
err = zeros(nsamples,1); % vector of errors between serial and parallel solutions
parfor i = 1:nsamples
  if mod(i,10)==0
    fprintf('Parfor loop, i = %d\n', i);
  end
  [~,y_par{i}] = ode15s(@(t,y) stiffODEfun(t,y,coef(i)) ,[0 10000],[2 0]);
  err(i) = norm(y_par{i}-y_ser{i}); % error between serial and parallel solutions
end
time_parfor = toc(time_parfor);
time_par = time_parfor + time_pool;

% print results
fprintf('RESULTS\n\n')
fprintf('Serial time : %g\n', time_ser)
fprintf('Parfor time : %g\n', time_par)
fprintf('Speedup : %g\n\n', time_ser/time_par)
fprintf('Max error between serial and parallel solutions = %e\n', max(abs(err)))

% close the parallel pool
delete(gcp)
exit
</code></pre>

<p>其中使用了函数 <code>stiffODEfun</code>：</p>
<pre><code class="matlab">function dy = stiffODEfun(t,y,c)
  % This is a modified example from MATLAB's documentation at:
  % http://www.mathworks.com/help/matlab/ref/ode15s.html
  % The difference here is that the coefficient c is passed as an argument.
    dy = zeros(2,1);
    dy(1) = y(2);
    dy(2) = c*(1 - y(1)^2)*y(2) - y(1);
end
</code></pre>

<p>提交作业的脚本 <code>submit_parfor.pbs</code> ，其中使用了一个节点的24个核心，ppn即为所使用的核心数，这与matlab代码中的 <code>parpool()</code> 第二个参数要保持一致：</p>
<pre><code class="bash">#!/bin/bash

#PBS -N matlab_parfor
### use one node with 24 cores for this job
#PBS -l nodes=1:ppn=24
#PBS -q default

BASE_MFILE_NAME=matlab_parfor
MATLAB_OUTPUT=${BASE_MFILE_NAME}.out

cd $PBS_O_WORKDIR
module load matlab/2016b
matlab -nodisplay -nosplash -r $BASE_MFILE_NAME &gt; $MATLAB_OUTPUT
</code></pre>

<h2 id="_3">运行多个并行任务</h2>
<p>matlab 使用了一个磁盘上的临时文件来存储一些作业信息，每份作业的信息是不相同的。当同时提交多个并行任务时，多个任务同时去同一个临时文件上读取这份信息，有可能导致程序错误。为避免错误，我们可以手动设定这个临时文件夹：在提交作业的脚本中创建一个临时文件夹，并告知matlab使用这个地址，临时文件夹名使用了作业ID：</p>
<pre><code class="bash">#!/bin/bash

#PBS -N matlab_parfor
### use one node with 24 cores for this job
#PBS -l nodes=1:ppn=24
#PBS -q default

BASE_MFILE_NAME=matlab_parfor
MATLAB_OUTPUT=${BASE_MFILE_NAME}.out

cd $PBS_O_WORKDIR
# create a temporary dir for your parallel job
mkdir -p $PBS_JOBID
module load matlab/2016b
matlab -nodisplay -nosplash -r $BASE_MFILE_NAME &gt; $MATLAB_OUTPUT

# clean up the temporary dir you just created before
rm -rf $PBS_JOBID
</code></pre>

<p>注意 matlab 中要 <code>pc.JobStorageLocation = getenv('PBS_JOBID')</code> 对临时文件地址做修改。</p>
<pre><code class="matlab">% start the matlabpool with maximum available workers
% control how many parallel workers you want to set
pc = parcluster('local', 24)

% explicitly set the JobStorageLocation to the temp directory that was created in your submit job script
pc.JobStorageLocation = getenv('PBS_JOBID')

parpool(pc, 24)

% run a parfor loop, distributing the iterations to 24 workers
parfor i = 1:100
        ones(10,10)
end
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../singularity/" class="btn btn-neutral float-right" title="Singularity">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../ml/" class="btn btn-neutral" title="机器学习"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright © 中国人民大学大型科学仪器共享平台</p>
    
  </div>

</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../ml/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../singularity/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
