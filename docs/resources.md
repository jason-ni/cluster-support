# 合理申请计算资源

高性能计算集群具有公共共享属性的，多个院系的老师和学生都会在我们的平台上进行计算和研究，而计算资源是有限的，为充分利用这些计算资源，同时满足自己的研究进展，需要用户合理地申请计算资源。个人申请过多资源，不仅**不会加速你的程序**，而且会**导致自己和别人的作业排队等待**；个人申请过少的资源，会导致自己的作业运行时间过长，长期占用某些资源，也不利于资源的长久持续利用。因此，我们希望用户申请适合自己的计算资源。

## 不要一次提交过多作业

集群禁止短时间内提交超过20个作业，尤其是运行时间超过三天且占用大量CPU资源的作业。第一次发现，管理员将发出警告。超过三次，管理员将停用该账号一段时间。如有特殊计算需求，请将需求邮件发送给 <hpc@ruc.edu.cn> 以报备。

## 队列选择

目前我们拥有三个主要队列。其中 default 为默认计算队列，队列每台机器有24核心CPU和64GB内存，用以执行绝大多数普通计算任务；pnode 为胖节点队列，队列每台机器有40核心CPU和256GB内存，胖节点资源非常有限，如无特殊需求，请不要使用这个队列；debug 队列专门为调试程序使用，对于新的程序，建议先使用debug队列来调试，调试无问题后，改为 default 队列来执行。

| 队列名  	| 计算资源                     	| 用途           	|
|---------	|------------------------------	|----------------	|
| default 	| 49台 * 24核处理器 / 64GB内存 	| 普通计算任务   	|
| pnode   	| 5台 * 40核处理器/ 256GB内存  	| 高负荷计算任务 	|
| debug   	| 2台 * 24核处理器 / 64GB内存  	| 调试程序专用   	|

## 申请CPU资源

每次提交作业时，都需要通过调度器来协调资源，具体使用上，需要编写一个 PBS 脚本，并在脚本中写明所需要的CPU资源。PBS脚本中需要有`#PBS -l nodes=1:ppn=12`这样的内容来申请CPU资源。[调度器介绍页面](job-scheduler.md)已经介绍了调度器的详细使用方法。

对于一些用户，可能不确定如何申请资源，这里根据下图的逻辑给出一些建议。

![资源申请导图](img/cpu_resources.png)

*图 资源申请导图*


如果你对自己的程序是否使用了多核加速不太确定，那么可以使用下面的方法监控自己的程序，并调整自己的 `ppn` 的设置。

## 监控自己的程序

* 先在登录节点qstat 得到你要查看的jobid，如下面所示的 6458 ：

```
Job ID                    Name             User            Time Use S Queue
------------------------- ---------------- --------------- -------- - -----
6458.rmdx-cluster         6-TZ-CCSDT-4.0-1 jh2017102784    188:34:4 R default
```

* 然后qstat -f jobid(如6458)，在结果中找到 exec_host 那一行中，为你作业实际执行的节点。

```
exec_host = node-1-12/9+node-1-12/10+node-1-12/11+node-1-12/12
```

忽略`/`后面内容，程序实际执行的节点是 node-1-12 这台机器。

* 使用`ssh node-1-12`命令登录到执行作业的节点，使用`top`命令，进入交互界面，查看该机器上的作业实时运行情况。

![top示意图](img/top.png)

上图中，每一行表示一个程序进程，USER列为提交作业的用户，%CPU列为作业本身所需要的CPU资源，100%表示该程序占用1个CPU核心，2400%表示占用24个核心。其他非用户行可不用关心。

![CPU多核运行情况示意图](img/top_with_cpus.png)

在top命令下，输入数字1，可以查看每个CPU的运行情况，得到如上图所示。

输入 q 可退出top命令交互界面。

* 在 node-1-12 上输入 `exit` 回到登录节点。